stages:
  - build
  - release

variables:
  APP_NAME: codepointer
  CMAKE_VERSION: "3.31.0"
  QT_VERSION: "6.10.1"
  BUILD_TYPE: "Release"

cache:
  paths:
    - .cache/pip
    - Qt/

# ----------------------------------------
# Build matrix (Linux, Windows, macOS)
# ----------------------------------------
build-cmake:
  stage: build
  parallel:
    matrix:
      - NAME: "Ubuntu GCC"
        OS: linux
        RUNNER_TAG: saas-linux-small-amd64
        BUILD_DIR: linux-gcc
        CC: gcc
        CXX: g++
      - NAME: "macOS"
        OS: macos
        RUNNER_TAG: saas-macos-large-m2pro
        BUILD_DIR: macos
        CC: clang
        CXX: clang++
      - NAME: "Windows MSVC"
        OS: windows
        RUNNER_TAG: saas-windows-medium-amd64
        BUILD_DIR: windows-msvc
        CC: cl
        CXX: cl

  tags:
    - $RUNNER_TAG

  before_script:
    - echo "Building $NAME with Qt $QT_VERSION"

    # Version handling (works in PowerShell too)
    - |
      if ($env:CI_COMMIT_TAG) {
        $env:VERSION = $env:CI_COMMIT_TAG
      } else {
        $env:VERSION = $env:CI_COMMIT_SHORT_SHA
      }
      echo "VERSION=$env:VERSION"

    # Qt installation (aqtinstall uses Python, works cross-platform)
    - |
      if ($env:OS -eq "linux") {
        sudo apt update
        sudo apt install -y python3-pip
      }
      if ($env:OS -eq "linux" -or $env:OS -eq "macos") {
        python3 -m pip install --user aqtinstall
        python3 -m aqt install-qt $env:OS desktop $QT_VERSION gcc_64 -m qt5compat
        $env:QT_ROOT_DIR = "$env:HOME/Qt/$QT_VERSION/gcc_64"
        $env:PATH = "$env:QT_ROOT_DIR/bin;$env:PATH"
      }
      if ($env:OS -eq "windows") {
        python -m pip install --user aqtinstall
        aqt install-qt windows desktop $QT_VERSION win64_msvc2022_64 -m qt5compat
        $env:QT_ROOT_DIR = "$pwd\Qt\$QT_VERSION\msvc2022_64"
        $env:PATH = "$env:QT_ROOT_DIR\bin;$env:PATH"
      }

  script:
    # Platform-specific dependencies
    - |
      if ($env:OS -eq "linux") {
        sudo apt install -y libcups2-dev python3-pip ninja-build
        pip3 install cmake-format
      }
      if ($env:OS -eq "windows") {
        choco install innosetup -y
      }

    # CMake build (common, works in PowerShell)
    - cmake -B build/$BUILD_DIR -G Ninja -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DCMAKE_C_COMPILER=$CC -DCMAKE_CXX_COMPILER=$CXX -DBUILD_VERSION=OFFICIAL
    - cmake --build build/$BUILD_DIR --parallel --verbose
    - cmake --install build/$BUILD_DIR --prefix dist/$BUILD_DIR/usr

    # Linux packaging (unchanged, only runs on Linux runner)
    - |
      if ($env:OS -eq "linux") {
        mkdir -p dist/$APP_NAME
        New-Item -ItemType SymbolicLink -Path dist/$APP_NAME -Name "$APP_NAME-$BUILD_DIR-$env:VERSION" -Target "../$BUILD_DIR/usr"
        tar -czhf dist/$APP_NAME-$BUILD_DIR-qt$QT_VERSION-$env:VERSION.tar.gz -C dist/$APP_NAME .

        sudo apt install -y fuse libxkbcommon-x11-0 libxcb-cursor-dev libxkbcommon-dev

        $env:OUTPUT = "build/$APP_NAME-$env:VERSION-x86_64.AppImage"
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage

        ./linuxdeploy-x86_64.AppImage --appdir dist/$BUILD_DIR --plugin qt --output appimage
      }

    # Windows packaging (translated to PowerShell)
    - |
      if ($env:OS -eq "windows") {
        # Load VS developer command prompt (required for cl and MSVC env)
        & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"

        windeployqt --release --no-translations --no-system-d3d-compiler --no-compiler-runtime --no-opengl-sw dist\$BUILD_DIR\usr\bin\$APP_NAME.exe
        iscc setup_script.iss
        Copy-Item dist\$APP_NAME-win64.exe dist\$APP_NAME-$env:VERSION-x86_64.exe
      }

  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - dist/
      - build/*.AppImage
      - dist/$APP_NAME-*-x86_64.exe  # Covers versioned Windows exe

# ----------------------------------------
# Release job (tags only)
# ----------------------------------------
create-release:
  stage: release
  needs: ["build-cmake"]
  tags:
    - linux
  rules:
    - if: $CI_COMMIT_TAG

  script:
    - echo "Creating GitLab Release for $CI_COMMIT_TAG"
    - |
      release-cli create \
        --name "$CI_COMMIT_TAG" \
        --tag-name "$CI_COMMIT_TAG" \
        --description "Automated release for $CI_COMMIT_TAG" \
        --assets-link "{\"name\":\"Artifacts\",\"url\":\"$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/download?job=build-cmake\"}"
